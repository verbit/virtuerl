name: Build
on:
  push:
    branches-ignore:
      - main
jobs:
  restvirt:
    name: Restvirt
    runs-on: self-hosted
    steps:
      - name: Set up Python 3.10.6
        id: python
        uses: actions/setup-python@v4
        with:
          python-version: 3.10.6
      - name: Check out code
        uses: actions/checkout@v3
      - name: Install dependencies
        run: |
          sudo apt update
          sudo apt install -y libvirt-dev
          pip install -r requirements.txt -r requirements-dev.txt
      - name: Lint
        run: |
          black --check --diff --color ./
          isort --check --diff --color ./
      - name: Unit Tests
        run: |
          tmp_dir=$(mktemp -d)
          chmod -R 0711 "${tmp_dir}"
          sudo iptables -P FORWARD ACCEPT
          sudo ${{ steps.python.outputs.python-path }} -m pytest tests/unit
      - name: Build Snap
        run: |
          sudo snap install --classic snapcraft
          sudo usermod --append --groups lxd $(whoami)
          sudo lxd init --auto
          snapcraft --use-lxd
      - name: Integration Tests
        run: |
          sudo snap install --dangerous minivirt*.snap
          sudo snap connect minivirt:network-control
          sudo snap connect minivirt:firewall-control
          sudo snap connect minivirt:libvirt
          cat << EOF | sudo tee -a /var/snap/minivirt/common/ca.crt
          -----BEGIN CERTIFICATE-----
          MIICBDCCAYqgAwIBAgIRAOfU+EvUkVhYLwFKwS1rp1kwCgYIKoZIzj0EAwMwQzEL
          MAkGA1UEBhMCREUxDzANBgNVBAgTBkJlcmxpbjEPMA0GA1UEBxMGQmVybGluMRIw
          EAYDVQQKEwlvc2FmdC5kZXYwHhcNMjIwODIxMTEwNjA2WhcNMzIxMTI2MTEwNjA2
          WjBDMQswCQYDVQQGEwJERTEPMA0GA1UECBMGQmVybGluMQ8wDQYDVQQHEwZCZXJs
          aW4xEjAQBgNVBAoTCW9zYWZ0LmRldjB2MBAGByqGSM49AgEGBSuBBAAiA2IABMSJ
          ajmDRZT8lFk/mUh32cIpoa/0TmWOtyyP8ivEjerFpiTnX+o6Umu/66R5p52D9D0d
          +3L8Hs4DR4xfbugECKdMBlBQUl3al1VZKLSM+S+sAiqQxgsP+ZvXRCjsM/DEsaNC
          MEAwDgYDVR0PAQH/BAQDAgEGMA8GA1UdEwEB/wQFMAMBAf8wHQYDVR0OBBYEFOEI
          RRLKbTHzEmS6nKa2BkD1rrh3MAoGCCqGSM49BAMDA2gAMGUCMQDYfKvPNIkv3veR
          tmr4InE2Nay07ePvRn4dIXIBOIAXqjzsaZeVBpNfV2K5qi+4kW4CMGxeiGH+4HA0
          LclhLWjLmOZnTRAT8chHkNh8z+3EXt4cmJ3wpLTTkuhxmYQwS6mBrA==
          -----END CERTIFICATE-----
          EOF
          cat << EOF | sudo tee -a /var/snap/minivirt/common/server.crt
          -----BEGIN CERTIFICATE-----
          MIICYjCCAeegAwIBAgIQbVv7tB/q2tQqDT3ZgWznCjAKBggqhkjOPQQDAzBDMQsw
          CQYDVQQGEwJERTEPMA0GA1UECBMGQmVybGluMQ8wDQYDVQQHEwZCZXJsaW4xEjAQ
          BgNVBAoTCW9zYWZ0LmRldjAeFw0yMjA4MjExMTA2MDZaFw0zMjExMjYxMTA2MDZa
          MFcxCzAJBgNVBAYTAkRFMQ8wDQYDVQQIEwZCZXJsaW4xDzANBgNVBAcTBkJlcmxp
          bjESMBAGA1UEChMJb3NhZnQuZGV2MRIwEAYDVQQDEwlvc2FmdC5kZXYwdjAQBgcq
          hkjOPQIBBgUrgQQAIgNiAASxu/GUY+FihAR/EAf6o9tCVPMWUzAANMF+0+D0XHAH
          k1SELZsg7ZQ9zwSJtclZHG3lB2e4r8uW4q/hJbKwauM4347F1sD1TdrQzsflQDHM
          6S1UJmp8z6YblEacWgp970WjgYswgYgwDgYDVR0PAQH/BAQDAgWgMBMGA1UdJQQM
          MAoGCCsGAQUFBwMBMAwGA1UdEwEB/wQCMAAwHwYDVR0jBBgwFoAU4QhFEsptMfMS
          ZLqcprYGQPWuuHcwMgYDVR0RBCswKYILcGF0Y2gucGxhY2WCCW9zYWZ0LmRldoIJ
          bG9jYWxob3N0hwTAqHoBMAoGCCqGSM49BAMDA2kAMGYCMQCEpBNSt3rxydDMYxP5
          by/8lxXAnlzj5giAv4MPuoX+nobc6IipEhtTXUydUnrkSPQCMQCkMiKObWQn6yk1
          9XGIqdSQcS/unAilbrjf8J+BfZemdntXvIz8lReizV2pgyFGO1k=
          -----END CERTIFICATE-----
          EOF
          cat << EOF | sudo tee -a /var/snap/minivirt/common/server.key
          -----BEGIN EC PRIVATE KEY-----
          MIGkAgEBBDCWM9jrmN8xhoA0nmXKvhuyPsnO+2zjVrN1hmfSqRjlHRokjFxW9Gmd
          ehdVNofOkEWgBwYFK4EEACKhZANiAASxu/GUY+FihAR/EAf6o9tCVPMWUzAANMF+
          0+D0XHAHk1SELZsg7ZQ9zwSJtclZHG3lB2e4r8uW4q/hJbKwauM4347F1sD1TdrQ
          zsflQDHM6S1UJmp8z6YblEacWgp970U=
          -----END EC PRIVATE KEY-----
          EOF
          sudo snap set minivirt controller.args='--debug -b :8093 -c $SNAP_COMMON --server-cert $SNAP_COMMON/server.crt --server-key $SNAP_COMMON/server.key --client-ca-cert $SNAP_COMMON/ca.crt'
          sudo snap start --enable minivirt.unbound
          sudo snap start --enable minivirt.controller

          sudo minivirt.register -a 127.0.0.1:8093 --name default -b 127.0.0.1:8099
          sudo snap start --enable minivirt.daemon

          sleep 10
          if ! sudo ${{ steps.python.outputs.python-path }} -m pytest tests/integration ; then
            sudo journalctl
            exit 1
          fi
#          sleep 5
#          snap services minivirt
#          sudo journalctl -e
#          sudo apt install -y net-tools
#          sudo netstat -tulpen
#          sudo ${{ steps.python.outputs.python-path }} -m pytest tests/integration
#          sudo journalctl -e
#          sudo netstat -tulpen
#      - name: Build
#        run: |
#          docker build --target test -t restvirt-tests .
#          docker build -t restvirt .
#      - name: Test
#        run: |
#          tmp_dir=$(mktemp -d)
#          chmod -R 0711 "${tmp_dir}"
#          iptables -P FORWARD ACCEPT
#          docker run --rm --cap-add=NET_ADMIN --network host -t -v /var/run/libvirt:/var/run/libvirt -v "${tmp_dir}":/data/restvirt/images restvirt-tests --pool-dir "${tmp_dir}"
