name: Deploy
on:
  push:
    tags:
      - v*
jobs:
  deploy:
    name: Deploy
    runs-on: ubuntu-latest
    env:
      TZ: Europe/Berlin
      DOCKER_BUILDKIT: 1
    steps:
      - name: Check out code
        uses: actions/checkout@v2
      - name: Login to GHCR
        uses: docker/login-action@v1
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Set version
        run: |
          # from refs/tags/v1.2.3 get 1.2.3
          VERSION=${GITHUB_REF#refs/tags/v}
          PLACEHOLDER='__version__ = "unknown"'
          VERSION_FILE='version.py'
          # ensure the placeholder is there. If grep doesn't find the placeholder
          # it exits with exit code 1 and github actions aborts the build.
          grep "$PLACEHOLDER" "$VERSION_FILE"
          sed -i "s/$PLACEHOLDER/__version__ = \"${VERSION}\"/g" "$VERSION_FILE"

          grep "version: 'git'" snap/snapcraft.yaml
          sed -i "s/version: 'git'/version: ${VERSION}/g" snap/snapcraft.yaml
      - name: Deploy image
        run: |
          IMAGE_VERSION=${GITHUB_REF#refs/tags/}
          docker build -t restvirt:${IMAGE_VERSION} .
          docker tag restvirt:${IMAGE_VERSION} ghcr.io/verbit/restvirt:${IMAGE_VERSION}
          docker push ghcr.io/verbit/restvirt:${IMAGE_VERSION}
      - name: Build Snap
        uses: snapcore/action-build@v1
        id: snapcraft
      - name: Deploy Snap
        uses: snapcore/action-publish@v1
        with:
          store_login: ${{ secrets.SNAP_CREDS }}
          snap: ${{ steps.snapcraft.outputs.snap }}
          release: release
